import geopandas as gpd
import matplotlib.pyplot as plt
import pandas as pd

# === 1) Convert Spark DataFrames to pandas ===
# Station locations (ID, LATITUDE, LONGITUDE)
nz_pdf = (nz_station_loc
          .select("ID", "LATITUDE", "LONGITUDE")
          .toPandas())

# Missing stats (ID, missing_year_total, missing_month_total)
missing_pdf = daily_nz_tmin_tmax_missing_stats.toPandas()

# === 2) Merge by station ID ===
merged = pd.merge(nz_pdf, missing_pdf, on="ID", how="left")

# === 3) Create GeoDataFrame ===
gdf_pts = gpd.GeoDataFrame(
    merged,
    geometry=gpd.points_from_xy(merged["LONGITUDE"], merged["LATITUDE"]),
    crs="EPSG:4326"
)

# Reproject to NZTM2000
gdf_pts_nztm = gdf_pts.to_crs(2193)

# === 4) Load New Zealand polygon (Natural Earth dataset) ===
world = gpd.read_file(gpd.datasets.get_path("naturalearth_lowres"))
nz_poly = world[world["name"] == "New Zealand"].to_crs(2193)

# === 5) Plot with colormap ===
fig, ax = plt.subplots(figsize=(8, 10))

# Plot main map
gdf_pts_nztm.plot(
    ax=ax,
    column="missing_month_total",
    cmap="Reds",
    markersize=80,
    legend=False   # disable default legend
)

# Add station labels
for _, r in gdf_pts_nztm.iterrows():
    ax.annotate(
        r["ID"],
        xy=(r.geometry.x, r.geometry.y),
        xytext=(3, 3),
        textcoords="offset points",
        fontsize=6
    )

# ==== Create a separate colorbar axis ====
# [left, bottom, width, height] relative to the whole figure
cax = fig.add_axes([0.92, 0.15, 0.02, 0.7])  
# 0.92 = horizontal position (closer to right), 0.02 = width of the colorbar

sm = plt.cm.ScalarMappable(
    cmap="Reds",
    norm=plt.Normalize(
        vmin=gdf_pts_nztm["missing_month_total"].min(),
        vmax=gdf_pts_nztm["missing_month_total"].max()
    )
)
sm._A = []  # required for older Matplotlib versions

cbar = fig.colorbar(sm, cax=cax)  
cbar.set_label("Missing Months (darker = more missing)", fontsize=10)

ax.set_title("NZ Weather Stations: Missing Months", fontsize=12)
ax.set_axis_off()

plt.show()