# === 0) Dependencies ===
# pip install geopandas pyproj shapely matplotlib  (if missing)

import geopandas as gpd
import pandas as pd
import matplotlib.pyplot as plt

# === 1) Convert Spark DataFrame to pandas with required columns ===
# Make sure your Spark DataFrame has columns: ID, LATITUDE, LONGITUDE
nz_pdf = (nz_station_loc
          .select("ID", "LATITUDE", "LONGITUDE")
          .toPandas())

# === 2) Build GeoDataFrame with point geometries (lon=x, lat=y) ===
gdf_pts = gpd.GeoDataFrame(
    nz_pdf,
    geometry=gpd.points_from_xy(nz_pdf["LONGITUDE"], nz_pdf["LATITUDE"]),
    crs="EPSG:4326"   # WGS84 geographic coordinates
)

# === 3) Load New Zealand polygon from built-in Natural Earth dataset ===
world = gpd.read_file(gpd.datasets.get_path("naturalearth_lowres"))
nz_poly = world[world["name"] == "New Zealand"].to_crs(2193)

# Reproject station points to NZTM2000 (EPSG:2193)
gdf_pts_nztm = gdf_pts.to_crs(2193)

# === 4) Plot map ===
fig, ax = plt.subplots(figsize=(7.5, 7.5))

# Draw New Zealand boundary
nz_poly.plot(ax=ax, edgecolor="black", linewidth=0.6, alpha=0.15)

# Draw station points
gdf_pts_nztm.plot(ax=ax, markersize=40, color="red")

# Optional: label station IDs (may overlap if points are close)
for _, r in gdf_pts_nztm.iterrows():
    ax.annotate(r["ID"], xy=(r.geometry.x, r.geometry.y),
                xytext=(3, 3), textcoords="offset points", fontsize=7)

ax.set_title("New Zealand Weather Stations (NZTM2000)", fontsize=12)
ax.set_axis_off()
plt.tight_layout()
plt.show()